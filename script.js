var testJson = [{"data1": "ТОО \"АВРОРА ХОЛДИНГ\"", "data2": "КАДАШНИКОВ МИХАИЛ ВАЛЕРЬЕВИЧ", "company1": "ТОО \"ALLDATA\"", "company2": "ТОО \"АВРОРА СЕРВИС\"", "data1_type": 1, "data2_type": 3, "general_biin": 100240000832, "general_data": "ТОО \"ЭТЗ АВРОРА\"", "general_type": 1, "company1_to_data1_role": "Учредитель", "company2_to_data2_role": "Бывший руководитель", "general_data_to_data1_role": "Учредитель", "general_data_to_data2_role": "Руководитель"}, {"data1": "ТОО \"АВРОРА ХОЛДИНГ\"", "data2": "ТОО \"АВРОРА ХОЛДИНГ\"", "company1": "ТОО \"ALLDATA\"", "company2": "ТОО \"АВРОРА СЕРВИС\"", "data1_type": 1, "data2_type": 1, "general_biin": 201040028925, "general_data": "ТОО \"АВРОРА 77\"", "general_type": 1, "company1_to_data1_role": "Учредитель", "company2_to_data2_role": "Учредитель", "general_data_to_data1_role": "Учредитель", "general_data_to_data2_role": "Учредитель"}, {"data1": "ТОО \"АВРОРА ХОЛДИНГ\"", "data2": "ТОО \"АВРОРА ХОЛДИНГ\"", "company1": "ТОО \"ALLDATA\"", "company2": "ТОО \"АВРОРА СЕРВИС\"", "data1_type": 1, "data2_type": 1, "general_biin": 200140024389, "general_data": "ТОО \"АВРОРА ХИМ СИСТЕМЫ\"", "general_type": 1, "company1_to_data1_role": "Учредитель", "company2_to_data2_role": "Учредитель", "general_data_to_data1_role": "Учредитель", "general_data_to_data2_role": "Учредитель"}, {"data1": "ТОО \"АВРОРА ХОЛДИНГ\"", "data2": "ТОО \"АВРОРА ХОЛДИНГ\"", "company1": "ТОО \"ALLDATA\"", "company2": "ТОО \"АВРОРА СЕРВИС\"", "data1_type": 1, "data2_type": 1, "general_biin": 50840005494, "general_data": "ТОО \"АВРОРА КОНСТРАКШЕН\"", "general_type": 1, "company1_to_data1_role": "Учредитель", "company2_to_data2_role": "Учредитель", "general_data_to_data1_role": "Учредитель", "general_data_to_data2_role": "Учредитель"}, {"data1": "ТОО \"АВРОРА ХОЛДИНГ\"", "data2": "ТОО \"АВРОРА ХОЛДИНГ\"", "company1": "ТОО \"ALLDATA\"", "company2": "ТОО \"АВРОРА СЕРВИС\"", "data1_type": 1, "data2_type": 1, "general_biin": 141140010115, "general_data": "ТОО \"АВРОРА ЭНЕРДЖИ\"", "general_type": 1, "company1_to_data1_role": "Учредитель", "company2_to_data2_role": "Учредитель", "general_data_to_data1_role": "Учредитель", "general_data_to_data2_role": "Учредитель"}, {"data1": "ТОО \"АВРОРА ХОЛДИНГ\"", "data2": "ТОО \"АВРОРА ХОЛДИНГ\"", "company1": "ТОО \"ALLDATA\"", "company2": "ТОО \"АВРОРА СЕРВИС\"", "data1_type": 1, "data2_type": 1, "general_biin": 180840010586, "general_data": "ТОО \"АВРОРА САППЛАЙ\"", "general_type": 1, "company1_to_data1_role": "Учредитель", "company2_to_data2_role": "Учредитель", "general_data_to_data1_role": "Учредитель", "general_data_to_data2_role": "Учредитель"}, {"data1": "ТОО \"АВРОРА ХОЛДИНГ\"", "data2": "ТОО \"АВРОРА ХОЛДИНГ\"", "company1": "ТОО \"ALLDATA\"", "company2": "ТОО \"АВРОРА СЕРВИС\"", "data1_type": 1, "data2_type": 1, "general_biin": 80540010158, "general_data": "ТОО \"ТОРГОВЫЙ ДОМ \"АВРОРА\"", "general_type": 1, "company1_to_data1_role": "Учредитель", "company2_to_data2_role": "Учредитель", "general_data_to_data1_role": "Учредитель", "general_data_to_data2_role": "Учредитель"}, {"data1": "ТОО \"АВРОРА ХОЛДИНГ\"", "data2": "ТОО \"АВРОРА ХОЛДИНГ\"", "company1": "ТОО \"ALLDATA\"", "company2": "ТОО \"АВРОРА СЕРВИС\"", "data1_type": 1, "data2_type": 1, "general_biin": 100940013094, "general_data": "ТОО \"ПРОИЗВОДСТВЕННЫЙ КОМПЛЕКС \"АВРОРА\"", "general_type": 1, "company1_to_data1_role": "Учредитель", "company2_to_data2_role": "Учредитель", "general_data_to_data1_role": "Учредитель", "general_data_to_data2_role": "Учредитель"}, {"data1": "ТОО \"АВРОРА ХОЛДИНГ\"", "data2": "ТОО \"АВРОРА ХОЛДИНГ\"", "company1": "ТОО \"ALLDATA\"", "company2": "ТОО \"АВРОРА СЕРВИС\"", "data1_type": 1, "data2_type": 1, "general_biin": 200840014832, "general_data": "ТОО \"АВРОРА 17\"", "general_type": 1, "company1_to_data1_role": "Учредитель", "company2_to_data2_role": "Учредитель", "general_data_to_data1_role": "Учредитель", "general_data_to_data2_role": "Учредитель"}, {"data1": "ТОО \"АВРОРА ХОЛДИНГ\"", "data2": "ТОО \"АВРОРА ХОЛДИНГ\"", "company1": "ТОО \"ALLDATA\"", "company2": "ТОО \"АВРОРА СЕРВИС\"", "data1_type": 1, "data2_type": 1, "general_biin": 141040029682, "general_data": "ТОО \"АВРОРА БРЕНДС\"", "general_type": 1, "company1_to_data1_role": "Учредитель", "company2_to_data2_role": "Учредитель", "general_data_to_data1_role": "Учредитель", "general_data_to_data2_role": "Учредитель"}, {"data1": "ТОО \"АВРОРА ХОЛДИНГ\"", "data2": "ТОО \"АВРОРА ХОЛДИНГ\"", "company1": "ТОО \"ALLDATA\"", "company2": "ТОО \"АВРОРА СЕРВИС\"", "data1_type": 1, "data2_type": 1, "general_biin": 100240000832, "general_data": "ТОО \"ЭТЗ АВРОРА\"", "general_type": 1, "company1_to_data1_role": "Учредитель", "company2_to_data2_role": "Учредитель", "general_data_to_data1_role": "Учредитель", "general_data_to_data2_role": "Учредитель"}, {"data1": "ТОО \"АВРОРА ХОЛДИНГ\"", "data2": "КАДАШНИКОВ МИХАИЛ ВАЛЕРЬЕВИЧ", "company1": "ТОО \"ALLDATA\"", "company2": "ТОО \"АВРОРА СЕРВИС\"", "data1_type": 1, "data2_type": 3, "general_biin": 100240000832, "general_data": "ТОО \"ЭТЗ АВРОРА\"", "general_type": 1, "company1_to_data1_role": "Учредитель", "company2_to_data2_role": "Бывший руководитель", "general_data_to_data1_role": "Учредитель", "general_data_to_data2_role": "Бывший руководитель"}, {"data1": "ТОО \"АВРОРА ХОЛДИНГ\"", "data2": "МАРТЫНЕНКО ИЛЬЯ ИЛЬИЧ", "company1": "ТОО \"ALLDATA\"", "company2": "ТОО \"АВРОРА СЕРВИС\"", "data1_type": 1, "data2_type": 3, "general_biin": 80540010158, "general_data": "ТОО \"ТОРГОВЫЙ ДОМ \"АВРОРА\"", "general_type": 1, "company1_to_data1_role": "Учредитель", "company2_to_data2_role": "Бывший руководитель", "general_data_to_data1_role": "Учредитель", "general_data_to_data2_role": "Бывший руководитель"}, {"data1": "ТОО \"АВРОРА ХОЛДИНГ\"", "data2": "БОГОМОЛОВА ЕВГЕНИЯ БОРИСОВНА", "company1": "ТОО \"ALLDATA\"", "company2": "ТОО \"АВРОРА СЕРВИС\"", "data1_type": 1, "data2_type": 3, "general_biin": 180840010586, "general_data": "ТОО \"АВРОРА САППЛАЙ\"", "general_type": 1, "company1_to_data1_role": "Учредитель", "company2_to_data2_role": "Бывший руководитель", "general_data_to_data1_role": "Учредитель", "general_data_to_data2_role": "Бывший руководитель"}, {"data1": "ТОО \"АВРОРА ХОЛДИНГ\"", "data2": "87273131188", "company1": "ТОО \"ALLDATA\"", "company2": "ТОО \"АВРОРА СЕРВИС\"", "data1_type": 1, "data2_type": 1, "general_biin": 50840005494, "general_data": "ТОО \"АВРОРА КОНСТРАКШЕН\"", "general_type": 1, "company1_to_data1_role": "Учредитель", "company2_to_data2_role": "Телефон", "general_data_to_data1_role": "Учредитель", "general_data_to_data2_role": "Телефон"}, {"data1": "ТОО \"АВРОРА ХОЛДИНГ\"", "data2": "87273131188", "company1": "ТОО \"ALLDATA\"", "company2": "ТОО \"АВРОРА СЕРВИС\"", "data1_type": 1, "data2_type": 1, "general_biin": 80540010158, "general_data": "ТОО \"ТОРГОВЫЙ ДОМ \"АВРОРА\"", "general_type": 1, "company1_to_data1_role": "Учредитель", "company2_to_data2_role": "Телефон", "general_data_to_data1_role": "Учредитель", "general_data_to_data2_role": "Телефон"}, {"data1": "ТОО \"АВРОРА ХОЛДИНГ\"", "data2": "87273131188", "company1": "ТОО \"ALLDATA\"", "company2": "ТОО \"АВРОРА СЕРВИС\"", "data1_type": 1, "data2_type": 1, "general_biin": 100940013094, "general_data": "ТОО \"ПРОИЗВОДСТВЕННЫЙ КОМПЛЕКС \"АВРОРА\"", "general_type": 1, "company1_to_data1_role": "Учредитель", "company2_to_data2_role": "Телефон", "general_data_to_data1_role": "Учредитель", "general_data_to_data2_role": "Телефон"}, {"data1": "ТОО \"АВРОРА ХОЛДИНГ\"", "data2": "87273131188", "company1": "ТОО \"ALLDATA\"", "company2": "ТОО \"АВРОРА СЕРВИС\"", "data1_type": 1, "data2_type": 1, "general_biin": 141040029682, "general_data": "ТОО \"АВРОРА БРЕНДС\"", "general_type": 1, "company1_to_data1_role": "Учредитель", "company2_to_data2_role": "Телефон", "general_data_to_data1_role": "Учредитель", "general_data_to_data2_role": "Телефон"}, {"data1": "ТОО \"АВРОРА ХОЛДИНГ\"", "data2": "87273131188", "company1": "ТОО \"ALLDATA\"", "company2": "ТОО \"АВРОРА СЕРВИС\"", "data1_type": 1, "data2_type": 1, "general_biin": 141140010115, "general_data": "ТОО \"АВРОРА ЭНЕРДЖИ\"", "general_type": 1, "company1_to_data1_role": "Учредитель", "company2_to_data2_role": "Телефон", "general_data_to_data1_role": "Учредитель", "general_data_to_data2_role": "Телефон"}, {"data1": "ТОО \"АВРОРА ХОЛДИНГ\"", "data2": "87273131993", "company1": "ТОО \"ALLDATA\"", "company2": "ТОО \"АВРОРА СЕРВИС\"", "data1_type": 1, "data2_type": 1, "general_biin": 50840005494, "general_data": "ТОО \"АВРОРА КОНСТРАКШЕН\"", "general_type": 1, "company1_to_data1_role": "Учредитель", "company2_to_data2_role": "Телефон", "general_data_to_data1_role": "Учредитель", "general_data_to_data2_role": "Телефон"}, {"data1": "ТОО \"АВРОРА ХОЛДИНГ\"", "data2": "87273131993", "company1": "ТОО \"ALLDATA\"", "company2": "ТОО \"АВРОРА СЕРВИС\"", "data1_type": 1, "data2_type": 1, "general_biin": 100240000832, "general_data": "ТОО \"ЭТЗ АВРОРА\"", "general_type": 1, "company1_to_data1_role": "Учредитель", "company2_to_data2_role": "Телефон", "general_data_to_data1_role": "Учредитель", "general_data_to_data2_role": "Телефон"}, {"data1": "ТОО \"АВРОРА ХОЛДИНГ\"", "data2": "87273131993", "company1": "ТОО \"ALLDATA\"", "company2": "ТОО \"АВРОРА СЕРВИС\"", "data1_type": 1, "data2_type": 1, "general_biin": 141140010115, "general_data": "ТОО \"АВРОРА ЭНЕРДЖИ\"", "general_type": 1, "company1_to_data1_role": "Учредитель", "company2_to_data2_role": "Телефон", "general_data_to_data1_role": "Учредитель", "general_data_to_data2_role": "Телефон"}, {"data1": "ТОО \"АВРОРА ХОЛДИНГ\"", "data2": "ТОО \"АВРОРА ХОЛДИНГ\"", "company1": "ТОО \"ALLDATA\"", "company2": "ТОО \"АВРОРА СЕРВИС\"", "data1_type": 1, "data2_type": 1, "general_biin": null, "general_data": "FUTURE MOTIVATION-UNIPESSOAL LDA", "general_type": 3, "company1_to_data1_role": "Учредитель", "company2_to_data2_role": "Учредитель", "general_data_to_data1_role": "Учреждаемый", "general_data_to_data2_role": "Учреждаемый"}, {"data1": "ТОО \"АВРОРА ХОЛДИНГ\"", "data2": "ТОО \"АВРОРА ХОЛДИНГ\"", "company1": "ТОО \"ALLDATA\"", "company2": "ТОО \"АВРОРА СЕРВИС\"", "data1_type": 1, "data2_type": 1, "general_biin": 821117399069, "general_data": "МАРТЫНЕНКО ИЛЬЯ ИЛЬИЧ", "general_type": 3, "company1_to_data1_role": "Учредитель", "company2_to_data2_role": "Учредитель", "general_data_to_data1_role": "Учреждаемый", "general_data_to_data2_role": "Учреждаемый"}, {"data1": "ТОО \"АВРОРА ХОЛДИНГ\"", "data2": "ТОО \"АВРОРА ХОЛДИНГ\"", "company1": "ТОО \"ALLDATA\"", "company2": "ТОО \"АВРОРА СЕРВИС\"", "data1_type": 1, "data2_type": 1, "general_biin": null, "general_data": "МАРТЫНЕНКО ИЛЬЯ ИЛЬИЧ", "general_type": 3, "company1_to_data1_role": "Учредитель", "company2_to_data2_role": "Учредитель", "general_data_to_data1_role": "Руководимый", "general_data_to_data2_role": "Учреждаемый"}, {"data1": "ТОО \"АВРОРА ХОЛДИНГ\"", "data2": "ТОО \"АВРОРА ХОЛДИНГ\"", "company1": "ТОО \"ALLDATA\"", "company2": "ТОО \"АВРОРА СЕРВИС\"", "data1_type": 1, "data2_type": 1, "general_biin": null, "general_data": "SIPAR GROUP LTD", "general_type": 1, "company1_to_data1_role": "Учредитель", "company2_to_data2_role": "Учредитель", "general_data_to_data1_role": "Бывший учреждаемый", "general_data_to_data2_role": "Бывший учреждаемый"}, {"data1": "ТОО \"АВРОРА ХОЛДИНГ\"", "data2": "ТОО \"АВРОРА ХОЛДИНГ\"", "company1": "ТОО \"ALLDATA\"", "company2": "ТОО \"АВРОРА СЕРВИС\"", "data1_type": 1, "data2_type": 1, "general_biin": 821117399069, "general_data": "МАРТЫНЕНКО ИЛЬЯ ИЛЬИЧ", "general_type": 3, "company1_to_data1_role": "Учредитель", "company2_to_data2_role": "Учредитель", "general_data_to_data1_role": "Учреждаемый", "general_data_to_data2_role": "Руководимый"}, {"data1": "ТОО \"АВРОРА ХОЛДИНГ\"", "data2": "ТОО \"АВРОРА ХОЛДИНГ\"", "company1": "ТОО \"ALLDATA\"", "company2": "ТОО \"АВРОРА СЕРВИС\"", "data1_type": 1, "data2_type": 1, "general_biin": null, "general_data": "МАРТЫНЕНКО ИЛЬЯ ИЛЬИЧ", "general_type": 3, "company1_to_data1_role": "Учредитель", "company2_to_data2_role": "Учредитель", "general_data_to_data1_role": "Руководимый", "general_data_to_data2_role": "Руководимый"}, {"data1": "ТОО \"АВРОРА ХОЛДИНГ\"", "data2": "ТОО \"АВРОРА ХОЛДИНГ\"", "company1": "ТОО \"ALLDATA\"", "company2": "ТОО \"АВРОРА СЕРВИС\"", "data1_type": 1, "data2_type": 1, "general_biin": null, "general_data": "ЯН АНДРЕЙ ВЛАДИМИРОВИЧ", "general_type": 3, "company1_to_data1_role": "Учредитель", "company2_to_data2_role": "Учредитель", "general_data_to_data1_role": "Бывший руководимый", "general_data_to_data2_role": "Бывший руководимый"}, {"data1": "ТОО \"АВРОРА ХОЛДИНГ\"", "data2": "ТОО \"АВРОРА ХОЛДИНГ\"", "company1": "ТОО \"ALLDATA\"", "company2": "ТОО \"АВРОРА СЕРВИС\"", "data1_type": 1, "data2_type": 1, "general_biin": null, "general_data": "ТОШПУЛАТОВ ФАРРУХ МУХАМАДОВИЧ", "general_type": 3, "company1_to_data1_role": "Учредитель", "company2_to_data2_role": "Учредитель", "general_data_to_data1_role": "Бывший руководимый", "general_data_to_data2_role": "Бывший руководимый"}, {"data2": "МАРТЫНЕНКО ИЛЬЯ ИЛЬИЧ", "company1": "ТОО \"ALLDATA\"", "company2": "ТОО \"АВРОРА СЕРВИС\"", "data2_type": 3, "general_biin": 100940005678, "general_data": "ТОО \"АВРОРА ХОЛДИНГ\"", "general_type": 1, "company2_to_data2_role": "Бывший руководитель", "company1_to_general_role": "Учредитель", "general_data_to_data2_role": "Учредитель"}, {"data2": "МАРТЫНЕНКО ИЛЬЯ ИЛЬИЧ", "company1": "ТОО \"ALLDATA\"", "company2": "ТОО \"АВРОРА СЕРВИС\"", "data2_type": 3, "general_biin": 100940005678, "general_data": "ТОО \"АВРОРА ХОЛДИНГ\"", "general_type": 1, "company2_to_data2_role": "Бывший руководитель", "company1_to_general_role": "Учредитель", "general_data_to_data2_role": "Руководитель"}, {"data2": "ЯН АНДРЕЙ ВЛАДИМИРОВИЧ", "company1": "ТОО \"ALLDATA\"", "company2": "ТОО \"АВРОРА СЕРВИС\"", "data2_type": 3, "general_biin": 100940005678, "general_data": "ТОО \"АВРОРА ХОЛДИНГ\"", "general_type": 1, "company2_to_data2_role": "Бывший руководитель", "company1_to_general_role": "Учредитель", "general_data_to_data2_role": "Бывший руководитель"}, {"data1": "ТОО \"АВРОРА ХОЛДИНГ\"", "company1": "ТОО \"ALLDATA\"", "company2": "ТОО \"АВРОРА СЕРВИС\"", "data1_type": 1, "general_biin": null, "general_data": "МАРТЫНЕНКО ИЛЬЯ ИЛЬИЧ", "general_type": 3, "company1_to_data1_role": "Учредитель", "company2_to_general_role": "Бывший руководитель", "general_data_to_data1_role": "Учреждаемый"}, {"data1": "ТОО \"АВРОРА ХОЛДИНГ\"", "company1": "ТОО \"ALLDATA\"", "company2": "ТОО \"АВРОРА СЕРВИС\"", "data1_type": 1, "general_biin": null, "general_data": "МАРТЫНЕНКО ИЛЬЯ ИЛЬИЧ", "general_type": 3, "company1_to_data1_role": "Учредитель", "company2_to_general_role": "Бывший руководитель", "general_data_to_data1_role": "Руководимый"}, {"data1": "ТОО \"АВРОРА ХОЛДИНГ\"", "company1": "ТОО \"ALLDATA\"", "company2": "ТОО \"АВРОРА СЕРВИС\"", "data1_type": 1, "general_biin": null, "general_data": "ЯН АНДРЕЙ ВЛАДИМИРОВИЧ", "general_type": 3, "company1_to_data1_role": "Учредитель", "company2_to_general_role": "Бывший руководитель", "general_data_to_data1_role": "Бывший руководимый"}];


var nodes = [],links = [],vocabularyNodes={},linkKeys = {},connectionsById={},connectionLinksById={};
let uniqId = 0;
let startScale = 1;
let pressDuration = 0;
let timerPressDuration;

let sizes = {
    windowWidth:window.innerWidth,
    windowHeight:window.innerHeight,
    rectWidth:150,
    rectHeight:100,
    rectHeaderSize:30,
    containerMarginX:0,
    containerMarginY:50,
    distanceBetweenRectX:100,
    distanceBetweenRectY:50,
    WindowSizeX:1200,
    linkWidth:1,
    toolbarButtonSize:80,
    spaceBetweenToolbarButtons:10,
}
let colors = {
    "Телефон":"red",
    "Руководитель":"green",
    "Бывший руководитель":"orange",
    "Учредитель":"#587AB0",
    "default":"gray",
}
function getColor(type){
    if(colors[type]){
        return colors[type];
    }
    return colors["default"];
}
function saveSVG(){

    var scaleValue=1;
    try{scaleValue = d3.select("#graphContainer").attr("transform").split("scale(")[1].split(")")[0]}
    catch {}

    var obj = document.getElementById("graphContainer");
    var objCopy = obj.cloneNode(true);
    objCopy.setAttribute("transform", "translate(0,20)");

    let h = obj.getBoundingClientRect().height/scaleValue;
    let w = obj.getBoundingClientRect().width/scaleValue;


    let newSvg = body.append("svg")
        .attr("id","newSvg")
        .attr("width",w)
        .attr("height",h+40)

    let newSvgDoc = document.getElementById("newSvg");
    newSvgDoc.appendChild(objCopy);


    var serializer = new XMLSerializer();
    var objStr = serializer.serializeToString(document.getElementById("newSvg"));


    let imgsrc = 'data:image/svg+xml;base64,' + btoa(unescape(encodeURIComponent(objStr)));


    newSvg.remove();


    var dlLink = document.createElement('a');
    dlLink.download = "connection graph";
    dlLink.href = imgsrc;

    document.body.appendChild(dlLink);
    dlLink.click();
    document.body.removeChild(dlLink);
}
function line(d){
    if(vocabularyNodes[d.source] && vocabularyNodes[d.target]) {
        let s = {
            x: vocabularyNodes[d.source].x + sizes.rectWidth,
            y: vocabularyNodes[d.source].y + 20,
        }
        let t = {
            x: vocabularyNodes[d.target].x,
            y: vocabularyNodes[d.target].y + 20,
        }
        let halfX = (s.x + t.x) / 2;
        let halfY = (s.y + t.y) / 2;
        let fourth1 = (s.x + halfX) / 2;
        let fourth2 = (t.x + halfX) / 2;

        return "M" + s.x + " " + s.y +" Q "+fourth1+" "+s.y+" "+(halfX)+" "+halfY+" T " + t.x + " " + t.y;
    }
    return
}
if(sizes.windowWidth>sizes.WindowSizeX){
    sizes["WindowSizeX"] = sizes.windowWidth;
}
sizes["company2X"] = sizes.WindowSizeX-sizes.rectWidth-10;
sizes["distanceBetweenRectX"] = (sizes.WindowSizeX-(sizes.rectWidth*5+20))/4;
sizes["data1X"] = sizes.rectWidth+sizes.distanceBetweenRectX;
sizes["general_dataX"] = (sizes.rectWidth+sizes.distanceBetweenRectX)*2;
sizes["data2X"] = (sizes.rectWidth+sizes.distanceBetweenRectX)*3;



let body = d3.select("body");
let svg = body.append("svg")
    .style("margin",0)
    .style("height",sizes.windowHeight)
    .style("width",sizes.windowWidth)
    .attr("id","svgId");

var container = svg.append("g")
    .attr("id","graphContainer")
    .attr("class","container")
    .attr("id","graphContainer")
    .attr("x",sizes.containerMarginX)
    .attr("y",sizes.containerMarginY)
    .attr("transform","translate("+sizes.containerMarginX+","+sizes.containerMarginY+") scale("+startScale+")");
var zoom = d3.behavior.zoom()
    .on("zoom",zoomMove)
    .scaleExtent([.4,4]);

function buttonZoomMove(zoomLevel){
    console.log("work");
    var zoomNum = 1;
    try{zoomNum = parseFloat( container.attr("transform").split("scale(")[1].split(")")[0])}
    catch {}
    zoom.scale(zoomNum+zoomLevel).event(container);
}

function zoomMove(){
    let x = sizes.containerMarginX+d3.event.translate[0];
    let y = sizes.containerMarginY+d3.event.translate[1];
    container.attr("transform","translate("+x+","+y+") scale("+(d3.event.scale-(1-startScale))+")")
}

//d3.select("#bigZoomButton").on("click",()=>buttonZoomMove((1.15-startScale)));
d3.select("#bigZoomButton").on("click",()=>alert("ok"));
d3.select("#lilZoomButton").on("click",()=>buttonZoomMove(.85-startScale));
svg.call(zoom);



function dataFormatter(data){

    let counter = 0;
    let counterLinks = 0;
    let level = 0;
    function addToConnectionsById(id1,id2,id3){
        let idArray = [];
        function addToMainCompanies(array){
            array.forEach(i=>{
                if(!connectionsById[0].includes(i)){
                    connectionsById[0].push(i);
                }
                if(!connectionsById[1].includes(i)){
                    connectionsById[1].push(i);
                }
            })
        }

        if(id1!=undefined){idArray.push(id1.id)}
        if(id2!=undefined){idArray.push(id2.id)}
        if(id3!=undefined){idArray.push(id3.id)}

        idArray.forEach(id=>{if(connectionsById[id]==undefined){connectionsById[id]=[0,1]}})
        if(connectionsById[0]==undefined||connectionsById[1]==undefined){connectionsById[0]=[0,1];connectionsById[1]=[0,1];}
        idArray.forEach(mainId=>{
            idArray.forEach(pushId=>{
                if(!connectionsById[mainId].includes(pushId)){
                    connectionsById[mainId].push(pushId)
                }
                if(!connectionsById[pushId].includes(mainId)){
                    connectionsById[pushId].push(mainId)
                }
            })
            addToMainCompanies(idArray);
        })

    }
    let company1 = {
        "id":uniqId++,
        "name":data[0].company1,
        "type":"company1",
        "x":10,
        "y":sizes.windowHeight/2,
        "role1":"Искомая компания 1",
        "role2":"Искомая компания 1",
    }
    vocabularyNodes[company1.name+company1.type] = {...company1}
    nodes[counter++]=company1;
    let company2 = {
        "id":uniqId++,
        "name":data[0].company2,
        "type":"company2",
        "x":sizes.company2X,
        "y":sizes.windowHeight/2,
        "role1":"Искомая компания 2",
        "role2":"Искомая компания 2",
    }
    vocabularyNodes[company2.name+company2.type] = {...company2}
    nodes[counter++]=company2;

    data.forEach(d=>{
        let addLevel = false;
        //creating nodes
        if(d.data1!=undefined && !vocabularyNodes[d.data1+"data1"]) {
            nodes[counter++] = {
                "id": uniqId++,
                "name": d.data1,
                "type": "data1",
                "level": level,
                "x": sizes.data1X,
                "y":level*(sizes.rectHeight+sizes.distanceBetweenRectY),
                "role1":d.company1_to_data1_role,
                "role2":d.general_data_to_data1_role,
            }
            vocabularyNodes[nodes[counter - 1].name+nodes[counter - 1].type] = {...nodes[counter - 1]}
            addLevel=true;
        }
        if(!vocabularyNodes[d.general_data+"general_data"]) {
            nodes[counter++] = {
                "id": uniqId++,
                "name": d.general_data,
                "type": "general_data",
                "level": level,
                "x": sizes.general_dataX,
                "y":level*(sizes.rectHeight+sizes.distanceBetweenRectY),
                "role1":"Компания",
                "role2":"Компания",
            }
            vocabularyNodes[nodes[counter - 1].name+nodes[counter-1].type] = {...nodes[counter - 1]}
            addLevel=true;
        }
        if(d.data2!=undefined && !vocabularyNodes[d.data2+"data2"]) {
            nodes[counter++] = {
                "id": uniqId++,
                "name": d.data2,
                "type": "data2",
                "level": level,
                "x":sizes.data2X,
                "y":level*(sizes.rectHeight+sizes.distanceBetweenRectY),
                "role1":d.general_data_to_data2_role,
                "role2":d.company2_to_data2_role,
            }
            vocabularyNodes[nodes[counter - 1].name+nodes[counter-1].type] = {...nodes[counter - 1]}
            addLevel=true;
        }
        //creating links
        if(d.company1_to_data1_role!=undefined && !linkKeys[d.company1+"company1"+d.data1+"data1"]) {
            links[counterLinks++] = {
                "source": d.company1+"company1",
                "target": d.data1+"data1",
                "type": "company1_to_data1_role",
                "role": d.company1_to_data1_role,
                "sourceId": vocabularyNodes[d.company1+"company1"].id,
                "targetId": vocabularyNodes[d.data1+"data1"].id,
            }
            linkKeys[d.company1+"company1"+d.data1+"data1"]=true;
        }
        if(d.general_data_to_data1_role!=undefined &&!linkKeys[d.data1+"data1"+d.general_data+"general_data"]) {
            links[counterLinks++] = {
                "source": d.data1+"data1",
                "target": d.general_data+"general_data",
                "type": "general_data_to_data1_role",
                "role": d.general_data_to_data1_role,
                "sourceId": vocabularyNodes[d.data1+"data1"].id,
                "targetId": vocabularyNodes[d.general_data+"general_data"].id,
            }
            linkKeys[d.data1+"data1"+d.general_data+"general_data"] = true;
        }
        if(d.general_data_to_data2_role!=undefined && !linkKeys[d.general_data+"general_data"+d.data2+"data2"]) {
            links[counterLinks++] = {
                "source": d.general_data + "general_data",
                "target": d.data2 + "data2",
                "type": "general_data_to_data2_role",
                "role": d.general_data_to_data2_role,
                "sourceId": vocabularyNodes[d.general_data + "general_data"].id,
                "targetId": vocabularyNodes[d.data2 + "data2"].id,
            }
            linkKeys[d.general_data+"general_data"+d.data2+"data2"] = true;
        }
        if(d.company2_to_data2_role!=undefined && !linkKeys[d.data2+"data2"+d.company2+"company2"]) {
            links[counterLinks++] = {
                "source": d.data2 + "data2",
                "target": d.company2 + "company2",
                "type": "company2_to_data2_role",
                "role": d.company2_to_data2_role,
                "sourceId": vocabularyNodes[d.data2 + "data2"].id,
                "targetId": vocabularyNodes[d.company2 + "company2"].id,
            }
            linkKeys[d.data2+"data2"+d.company2+"company2"]=true;
        }
        if(d.company1_to_general_role!=undefined && !linkKeys[d.company1+"company1"+d.general_data+"general_data"]){
            links[counterLinks++] = {
                "source": d.company1 + "company1",
                "target": d.general_data + "general_data",
                "type": "company1_to_general_role",
                "role": d.company1_to_general_role,
                "sourceId": vocabularyNodes[d.company1 + "company1"].id,
                "targetId": vocabularyNodes[d.general_data + "general_data"].id,
            }
            linkKeys[d.company1+"company1"+d.general_data+"general_data"]=true;
        }
        if(d.company2_to_general_role!=undefined && !linkKeys[d.company2+"company2"+d.general_data+"general_data"]){
            links[counterLinks++] = {
                "target": d.company2 + "company2",
                "source": d.general_data + "general_data",
                "type": "company2_to_general_role",
                "role": d.company2_to_general_role,
                "sourceId": vocabularyNodes[d.general_data + "general_data"].id,
                "targetId": vocabularyNodes[d.company2 + "company2"].id,
            }
            linkKeys[d.company2+"company2"+d.general_data+"general_data"]=true;
        }

        if(addLevel){
            level++;
        }
        addToConnectionsById(vocabularyNodes[d.data1+"data1"],vocabularyNodes[d.general_data+"general_data"],vocabularyNodes[d.data2+"data2"]);
    })
    renderCompareGraph();
}
function renderToolBar(){
    var toolBar = body.append("div")
        .attr("class","toolbar");

    var bigZoomButton = toolBar.append("div")
        .attr("id","bigZoomButton")
        .classed("toolbarButton plusButton",true)
        .on("dblclick.zoom",null)
        .style("width",sizes.toolbarButtonSize+"px")
        .style("height",sizes.toolbarButtonSize+"px")
        .style("right",(sizes.toolbarButtonSize+2*sizes.spaceBetweenToolbarButtons)+"px");

    bigZoomButton.append("img")
        .attr("src","https://raw.githubusercontent.com/tabler/tabler-icons/9113749e27e6273a421cbcaceaf15c9f15824890/icons/zoom-in.svg")
        .attr("alt","icon title");

    var lilZoomButton = toolBar.append("div")
        .classed("toolbarButton minusButton",true)
        .attr("id","lilZoomButton")
        .attr("transform","translate("+(sizes.windowWidth-(sizes.zoomButtonSize+sizes.spaceBetweenZoomButtons))+","+(sizes.spaceBetweenZoomButtons+sizes.zoomButtonSize)+")")
        .on("dblclick.zoom",null)
        .style("width",sizes.toolbarButtonSize+"px")
        .style("height",sizes.toolbarButtonSize+"px")
        .style("right",sizes.spaceBetweenToolbarButtons+"px");

    lilZoomButton.append("img")
        .attr("src","https://raw.githubusercontent.com/tabler/tabler-icons/9113749e27e6273a421cbcaceaf15c9f15824890/icons/zoom-out.svg")
        .attr("alt","icon title");

    var saveButton = toolBar.append("div")
        .classed("toolbarButton saveButton",true)
        .on("dblclick.zoom",null)
        .style("width",sizes.toolbarButtonSize+"px")
        .style("height",sizes.toolbarButtonSize+"px")
        .style("right",(2*sizes.toolbarButtonSize+3*sizes.spaceBetweenToolbarButtons)+"px")
        .on("click",saveSVG)

    saveButton.append("img")
        .attr("src","https://raw.githubusercontent.com/tabler/tabler-icons/9113749e27e6273a421cbcaceaf15c9f15824890/icons/download.svg")
        .attr("alt","icon title")

    var legendButton = toolBar.append("div")
        .classed("zoomButton legendButton openedLegend",true)
        .on("dblclick.zoom",null)
        .style("width",sizes.zoomButtonSize+"px")
        .style("height",sizes.zoomButtonSize+"px")
        .style("right",(3*sizes.zoomButtonSize+4*sizes.spaceBetweenZoomButtons)+"px")
        //.on("click",legendButtonClick);
}
function renderCompareGraph(){

    let input = body.append("input")
        .attr("id","search")
        .style({
            "position":"fixed",
            "z-index":12,
        });
    input.on("input",()=>{
        console.log(document.getElementById("search").value)
        })


    let highlighted = false;
    function highlightOn(id){
        //highlighted=true;
        rect.style("opacity",d=>connectionsById[id].includes(d.id)?1:.2);
        link.style("opacity",d=>{
            if(connectionsById[id].includes(d.sourceId) && connectionsById[id].includes(d.targetId)){
                return 1;
            }
            return 0;
        })
    }
    function highlightOff(){
            rect.style("opacity", 1);
            link.style("opacity", 1);
        }

    svg
        .on("mousedown",()=>{
            pressDuration = 0;
            timerPressDuration = setInterval(()=>{
                pressDuration++;
            },25);

        })
        .on("mouseup",()=>{
            if(pressDuration<6){
                highlightOff();
            }
            clearInterval(timerPressDuration)
        })

    var link = container.selectAll("path.link")
        .data(links)
        .enter()
        .append("path")
        .attr("class","link")
        .attr("d",d=>line(d))
        .attr("stroke-width",sizes.linkWidth)
        .attr("fill","none")
        .attr("stroke",d=>getColor(d.role))
        .style("opacity",1)

    var node = container.selectAll("g.node")
        .data(nodes)
        .enter()
        .append("g")
            .attr("class","node")
            .style("opacity",1);

    var rect = node.append("rect")
        .classed("card",true)
        .attr("height",sizes.rectHeight)
        .attr("width",sizes.rectWidth)
        .attr("x",d=>d.x)
        .attr("y",d=>d.y)
        .style({
            "rx":5,
            "stroke-width":2,
            "stroke":"#587AB0",
            "fill":"#EDF8F9",
        });


    var rectContainer = node.append("foreignObject")
        .attr("height",sizes.rectHeight)
        .attr("width",sizes.rectWidth)
        .attr("x",d=>d.x)
        .attr("y",d=>d.y)
        .on("click",d=>{
            highlightOn(d.id);
        })

    var rectHeader = rectContainer.append("xhtml:div")
        .classed("nonIdenticalRoles",d=>d.role1!=d.role2?true:false)
        .style({
            "height":sizes.rectHeaderSize+"px",
            "width":(sizes.rectWidth-8)+"px",
            "border-bottom":"1px solid black",
            "margin":"4px",
            "display":"flex",
            "flex-direction":"row",
            "align-items":"center",
            "justify-content":"center",
        });
        rectHeader.append("h3")
            .attr("style",d=>d.role1!=d.role2?"width:50%;font-size:10px;":"align-text:center;font-size:12px;")
            .style({
                "display":"-webkit-box",
                "-webkit-line-clamp":2,
                "-webkit-box-orient":"vertical",
                "text-overflow":"ellipsis",
                "overflow":"hidden",
            })
        .text(d=>d.role1)
    d3.selectAll("div.nonIdenticalRoles").append("h3")
        .style({
            "font-size":"10px",
            "display":"-webkit-box",
            "-webkit-line-clamp":2,
            "-webkit-box-orient":"vertical",
            "text-overflow":"ellipsis",
            "overflow":"hidden",
            "text-align":"right",
            "width":sizes.rectWidth/2+"px",
        })
        .text(d=>d.role2)

    rectContainer.append("xhtml:h3")
        .style({
            "height":(sizes.rectHeight-sizes.rectHeaderSize-10)+"px",
            "font-size":"11px",
            "margin":"4px",
            "overflow":"hidden",
        })
        .text(d=>d.name)

}
renderToolBar();
dataFormatter(testJson);

